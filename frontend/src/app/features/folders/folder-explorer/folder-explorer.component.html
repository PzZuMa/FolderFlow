<div class="explorer-container">
  <mat-toolbar class="internal-toolbar">
    <button mat-icon-button
            *ngIf="currentFolderId !== null"
            (click)="navigateUp()"
            matTooltip="Subir un nivel"
            aria-label="Subir un nivel">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span *ngIf="currentFolderId !== null" class="toolbar-separator"></span>

    <div class="breadcrumb-display-container">
      <ng-container *ngIf="currentFolderId !== null && breadcrumbs.length > 0">
        <ng-container *ngFor="let crumb of breadcrumbs; let isLast = last; let isFirst = first">  

          <button mat-button class="breadcrumb-button"
                  *ngIf="!(isFirst && isRootId(crumb._id) && breadcrumbs.length === 1)"
                  (click)="navigateToBreadcrumb(isRootId(crumb._id) ? null : crumb._id)"
                  [disabled]="isLast"
                  [matTooltip]="isLast ? '' : ('Ir a ' + crumb.name)"
                  type="button">
            {{ crumb.name }}
          </button>
          <mat-icon class="breadcrumb-separator" *ngIf="!isLast">chevron_right</mat-icon>
        </ng-container>
      </ng-container>

      <span *ngIf="currentFolderId === null || (currentFolderId !== null && breadcrumbs.length === 0)" class="toolbar-title">
        {{ currentFolderNameDisplay }}
      </span>
    </div>

    <span class="toolbar-spacer"></span>
  </mat-toolbar>

  <mat-progress-bar mode="indeterminate" *ngIf="isLoading && uploads.length === 0"></mat-progress-bar>

  <div *ngIf="uploads.length > 0" class="upload-section">
    <h4>Subidas en progreso:</h4>
    <div class="upload-items-container">
       <div *ngFor="let upload of uploads; let i = index" class="upload-item"
            [ngClass]="{'upload-success': upload.status === 'success', 'upload-error': upload.status === 'error'}">
           <mat-icon class="upload-icon">{{ getIconForMimeType(upload.file.type) }}</mat-icon>
           <div class="upload-info">
             <span class="upload-title">{{ upload.file.name }}</span>
             <span class="upload-details">
                 <span *ngIf="upload.status === 'pending'">Pendiente...</span>
                 <span *ngIf="upload.status === 'uploading'">{{ upload.progress }}%</span>
                 <span *ngIf="upload.status === 'confirming'">Confirmando...</span>
                 <span *ngIf="upload.status === 'success'">¡Listo!</span>
                 <span *ngIf="upload.status === 'error'" class="error-message">Error: {{ upload.error }}</span>
                 - {{ formatBytes(upload.file.size) }}
             </span>
             <mat-progress-bar *ngIf="upload.status === 'uploading' || upload.status === 'confirming'"
                               mode="determinate" [value]="upload.progress" class="upload-progress-bar">
             </mat-progress-bar>
           </div>
       </div>
    </div>
  </div>

  <div class="content-area">
    <div *ngIf="!isLoading" class="grid-container">

      <mat-card *ngFor="let folder of folders" class="grid-item folder-card" (click)="navigateToFolder(folder._id)" [matTooltip]="'Abrir ' + folder.name">
         <mat-card-content>
             <mat-icon class="item-icon">folder</mat-icon>
             <span class="item-name">{{ folder.name }}</span>
         </mat-card-content>
         <button mat-icon-button [matMenuTriggerFor]="itemMenuFolder" (click)="$event.stopPropagation()" class="item-menu-button" aria-label="Acciones de carpeta">
             <mat-icon>more_vert</mat-icon>
         </button>
          <mat-menu #itemMenuFolder="matMenu">
              <button mat-menu-item (click)="navigateToFolder(folder._id)"><mat-icon>open_in_new</mat-icon><span>Abrir</span></button>
              <button mat-menu-item (click)="openMoveDialog(folder, 'folder')"><mat-icon>drive_file_move</mat-icon><span>Mover a...</span></button>
              <mat-divider></mat-divider>
              <button mat-menu-item (click)="openDeleteConfirmation(folder, 'folder')" color="warn"><mat-icon>delete</mat-icon><span>Eliminar</span></button>
         </mat-menu>
      </mat-card>

      <ng-container *ngIf="currentFolderId !== null">
          <mat-card *ngFor="let document of documents" class="grid-item document-card" [matTooltip]="document.name">
              <mat-card-content>
                  <mat-icon class="item-icon">{{ getIconForMimeType(document.mimeType) }}</mat-icon>
                  <span class="item-name">{{ document.name }}</span>
                  <span class="item-details">{{ formatBytes(document.size) }}</span>
              </mat-card-content>
              <button mat-icon-button [matMenuTriggerFor]="itemMenuDocument" (click)="$event.stopPropagation()" class="item-menu-button" aria-label="Acciones de documento">
                  <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #itemMenuDocument="matMenu">
                  <button mat-menu-item (click)="downloadFile(document)"><mat-icon>download</mat-icon><span>Descargar</span></button>
                  <button mat-menu-item (click)="openMoveDialog(document, 'document')"><mat-icon>drive_file_move</mat-icon><span>Mover a...</span></button>
                  <mat-divider></mat-divider>
                  <button mat-menu-item (click)="openDeleteConfirmation(document, 'document')" color="warn"><mat-icon>delete</mat-icon><span>Eliminar</span></button>
              </mat-menu>
          </mat-card>
      </ng-container>
    </div>

    <div *ngIf="!isLoading && folders.length === 0 && (!currentFolderId || documents.length === 0) && uploads.length === 0" class="empty-state">
       <mat-icon class="empty-icon">
         {{ currentFolderId === null ? 'folder_off' : 'search_off' }}
       </mat-icon>
       <span>
         {{ currentFolderId === null ? 'Crea tu primera carpeta para empezar.' : 'Esta carpeta está vacía.' }}
       </span>
    </div>
  </div>

  <input type="file" hidden #fileInput multiple (change)="onFileSelected($event)">

  <div class="fab-container">
      <button mat-fab color="accent" class="create-folder-fab" (click)="openCreateFolderDialog()" matTooltip="Nueva Carpeta" aria-label="Crear nueva carpeta">
          <mat-icon>create_new_folder</mat-icon>
      </button>
      <button mat-fab color="primary" class="upload-fab" *ngIf="currentFolderId !== null" (click)="triggerFileInputClick()" matTooltip="Subir archivo a esta carpeta" aria-label="Subir archivo">
          <mat-icon>upload_file</mat-icon>
      </button>
  </div>

</div>